---
title: "Creating Maps with ggplot2"
---

## Introduction

In this exercise we will use [_rnaturalearth_](https://github.com/ropenscilabs/rnaturalearth), [_simple features_](https://cran.r-project.org/web/packages/sf/vignettes/sf1.html) and
_ggplot2_ to create a map of Ethiopia and then a map of Oromia and highlight Oromia within a larger map of Ethiopia. Once we have the base maps of the country and regions we will add points to a map as commonly done to indicate sampling sites or plot locations, etc.

```{r libraries, message=FALSE}
library(dplyr)
library(ggplot2)
library(readr)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
```

## Create Country Level Map of Ethiopia

This is our base layer, Ethiopia, of the map using the shapefile from Del Ponte and Belachew's repository.

Using `download.file()`, we will download all the files necessary for the shapefile to create the base map of Ethiopia with internal zones and then load into our R session.

```{r ethiopia-base, message=FALSE, warning=FALSE}
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.CPG?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.CPG"),
              mode = "wb")
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.dbf?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.dbf"),
              mode = "wb")
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.prj?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.prj"),
              mode = "wb")
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.sbn?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.sbn"),
              mode = "wb")
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.sbx?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.sbx"),
              mode = "wb")
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.shp?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.shp"),
              mode = "wb")
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.shp.xml?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.shp.xml"),
              mode = "wb")
download.file("https://github.com/emdelponte/paper-coffee-rust-Ethiopia/blob/master/data/ethiopia-zone/Eth_Zone_2013.shx?raw=true",
              destfile = file.path(tempdir(), "Eth_Zone_2013.shx"),
              mode = "wb")

ethiopia_sf <- st_read(dsn = tempdir(), "Eth_Zone_2013")

plot(ethiopia_sf)
```

## Create a Map Using _ggplot2_

Using _ggplot2_, we have more control over how the data are displayed than using the base `plot()` command.

First, plot the whole country using _ggplot2_'s `geom_sf()` and the `ethiopia_sf` object.

```{r plot_level1}
ethiopia <- ggplot(ethiopia_sf) +
  geom_sf(fill = "white")

ethiopia
```

#### Projecting Map Data

That map works, but commonly maps should be projected and it is not.
Projections are used to reduce the distortion in the data that are displayed in a map.
There are [several types of map projections](https://imgs.xkcd.com/comics/map_projections.png) available.
For this map of Ethiopia we will use the Adindan projection, which has a EPSG (European Petroleum Survey Group) number of 4201 and is well suited for this part of the African continent.

```{r transform_sf}
ethiopia_sf <- st_transform(ethiopia_sf, crs = 4201)

ethiopia <- ggplot(ethiopia_sf) +
  geom_sf(fill = "white")

ethiopia
```

#### Add Labels to the States

The Natural Earth data have several columns to work with as we've already seen.
One of them is the two letter postal code for the states, `postal`.
Using `geom_sf_text()`, we can add this information to the map labelling the states.

```{r plot_level2}
ethiopia <-
  ethiopia +
  geom_sf_text(
    data = ethiopia_sf,
    aes(label = REGIONNAME),
    size = 2.5,
    hjust = 1
  )

ethiopia
```

#### Proper Labels and Theme

Properly label the x and y-axis and set the theme.
The _ggplot2_ theme, `theme_bw()` is nice to use with maps, so we will apply that here as well.

```{r plot_level3}
ethiopia <- 
  ethiopia +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw()

ethiopia
```

## Creating maps of Individual States

To create a map of only Oromia, subset the _sf_ object, `ethiopia_sf` such that it contains only the data for Oromia.

### Filter Oromia

```{r subset-oromia}
regions_sf <- filter(ethiopia_sf, REGIONNAME == "Oromia" |
                      REGIONNAME == "SNNPR")

regions_sf
```

### Plot Oromia AND SNNPR (Southern Nations, Nationalities and Peoples' Region)

After filtering Oromia SNNPR and creating a new object, we can plot it now.

```{r ggplot-oromia}
ggplot(data = regions_sf) +
  geom_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw()
```

## Highlighting Regions Within the Country

Using the `ethiopia_sf` and `regions_sf` objects that we have created, it is possible to create a map that highlights one state and labels it using the postal code, in this case Oromia and SNNPR.
Note that we use the `data` argument twice here.
Once for the base Ethipia map and once for the map of Oromia and SNNPR that we use to highlight the regions on the map.

```{r hightlight-oromia}
ggplot(data = ethiopia_sf) +
  geom_sf(fill = "white") +
  geom_sf(data = regions_sf,
          fill = "#512888") +
  geom_sf_text(
    data = regions_sf,
    aes(label = ZONENAME),
    colour = "white",
    size = 2.5,
    hjust = 1
  ) +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw()
```

## Adding and Labelling Points on a Map

Now we will build on the maps we created by adding points to a map of Oromia with latitude and longitude values.

### Create data.frame of Sampling Locations

Using the previously created `regions_sf` object, we will plot the locations of cities or towns in Oromia.
Now we will download the cleaned survey data from Del Ponte and Belechew (2020) directly into our R session.

```{r coffee-sampling, message=FALSE}
coffee_sampling <-
  read_csv(
    "https://raw.githubusercontent.com/emdelponte/paper-coffee-rust-Ethiopia/master/data/survey_clean.csv"
  )
```

### Converting Sites to an _sf_ Object

While we could plot everything using `geom_point()`, if we convert the `data.frame` to an `sf` type object, it is much more flexible and allows us to project the data for a more attractive map.

```{r convert-sf}
coffee_sampling <-
  st_as_sf(coffee_sampling,
           coords = c("lon", "lat"),
           crs = 4326)
coffee_sampling <- st_transform(coffee_sampling, crs = 4201)
```

Now we're ready to add the points to the map!

### Adding Sampling Locations to Map

Adding the points to the map works in the same fashion as adding layers in other _ggplot2_ objects.
You start with the base layer, in this case Oromia and SNNPR.
The zones are and add a layer with the points and another with the labels for the points.

```{r add-points}
ggplot() +
  geom_sf(data = regions_sf,
          aes(fill = ZONENAME)) +
  geom_sf(data = coffee_sampling,
          size = 2) +
  theme_bw() +
  xlab("Longitude") +
  ylab("Latitude")
```

## Further Reading and Resources

[Drawing beautiful maps programmatically with R, sf and ggplot2 — Part 1: Basics](https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html)

[Drawing beautiful maps programmatically with R, sf and ggplot2 — Part 2: Layers](https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html)

[Drawing beautiful maps programmatically with R, sf and ggplot2 — Part 3: Layouts](https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-3.html)
